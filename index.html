<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitação de Demostrações</title>
    <style>
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        
        /* --- INÍCIO DA ALTERAÇÃO --- */
        
        /* 1. Define a imagem de fundo */
        background-image: url('logo-brightlux-azul.png'); /* << TROQUE 'background.jpg' PELO NOME DA SUA IMAGEM */
        
        /* 2. Garante que a imagem cubra toda a tela */
        
        /* 3. Centraliza a imagem */
        background-position: center center;
        
        /* 4. Impede que a imagem se repita */
        background-repeat: no-repeat;
        
        /* 5. Fixa a imagem para que ela não role com a página (efeito parallax) */
        background-attachment: fixed;
        
        /* --- FIM DA ALTERAÇÃO --- */

        margin: 0;
        padding: 20px 0; /* Adiciona um pouco de espaço no topo e no fundo */
    }

    h1 {
        text-align: center;
        color: #0f4d80ff;
    }

    form {
        background: #fff;
        max-width: 580px;
        margin: 40px auto;
        padding: 32px 28px 24px 28px;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        gap: 18px;
        opacity: 95%;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    label {
        font-weight: 500;
        color: #22223b;
    }

    input[type="text"],
    input[type="email"],
    input[type="number"],
    select {
        width: 96%;
        padding: 8px 10px;
        border: 1px solid #c9c9c9;
        border-radius: 6px;
        font-size: 1rem;
        background: #f8fafc;
        transition: border 0.2s;
    }

    input:focus,
    select:focus {
        border-color: #4f8cff;
        outline: none;
        background: #fff;
    }

    #produtos-container {
        margin-bottom: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .produto-label-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .produto-row {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    button[type="button"]#add-produto {
        background: rgb(15, 128, 30);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 1.3rem;
        cursor: pointer;
        transition: background 0.2s;
        vertical-align: middle;
        margin-left: 6px;
    }

    button[type="button"]#add-produto:disabled {
        background: #bfc9d1;
        cursor: not-allowed;
    }

    .remove-produto-btn {
        background: #ff4f4f;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 1.3rem;
        cursor: pointer;
        margin-left: 4px;
        transition: background 0.2s;
    }

    button[type="submit"] {
        background: #0f4d80ff;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 10px 28px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        margin-top: 10px;
        transition: background 0.2s;
        align-self: flex-end;
    }

    button[type="submit"]:hover {
        background: #4f8cff;
    }
    input[type="date"] {
        width: 96%;
        padding: 8px 10px;
        border: 1px solid #c9c9c9;
        border-radius: 6px;
        font-size: 1rem;
        background: #f8fafc;
        transition: border 0.2s;
        color: #22223b;
    }

    input[type="date"]:focus {
        border-color: #4f8cff;
        outline: none;
        background: #fff;
    }

    .clausulas-texto {
        font-size: 1rem;
        color: #22223b;
        margin-bottom: 18px;
    }
    .clausulas-texto p {
        margin: 0 0 14px 0;
        text-indent: 1.5em;
        line-height: 1.6;
        text-align: justify;
    }
    .clausula-num {
        font-weight: 600;
        margin-left: 0;
        text-indent: 0;
    }
    .clausula-sub {
        display: inline-block;
        width: 2em;
        margin-left: 2em;
        font-weight: 500;
    }
    
    #cliente_email {
        border: 1.5px solid #4f8cff;
        background: #f0f6ff;
        color: #22223b;
    }

        /*
      Substitua todo o seu CSS anterior do .toggle por este bloco.
    */
    .toggle {
        display: flex;
        align-items: center;
        justify-content: center; /* Centraliza os itens */
        gap: 1rem; /* Aumenta o espaçamento */
        cursor: pointer;
        padding: 8px;
    }

    .toggle__label {
        font-weight: 600; /* Um pouco menos pesado que 900 */
        font-size: 1.1rem; /* Tamanho mais adequado para o formulário */
        color: #0f4d80ff;
        transition: opacity 0.4s ease-in-out; /* Adiciona transição suave */
    }

    /* Estilo inicial: Cliente ativo, Representante inativo */
    .toggle__label--cliente {
        opacity: 1;
    }
    .toggle__label--representante {
        opacity: 0.4;
    }
    
    /* Quando o checkbox está marcado (modo Representante) */
    #checkbox:checked + .toggle .toggle__label--cliente {
        opacity: 0.4; /* Cliente fica inativo */
    }
    #checkbox:checked + .toggle .toggle__label--representante {
        opacity: 1; /* Representante fica ativo */
    }
    
    .toggle__switch {
        --bg-toggle: hsl(0, 0%, 100%);
        --bg-circle: #0f4d80ff; /* Cor #22223b em HSL */
        --w-toggle-switch: 52px; /* Reduzido para um visual mais clean */
        --w-h-toggle-circle: 20px;
        --pd-toggle-switch: 4px;
        height: 28px;
        width: var(--w-toggle-switch);
        background-color: var(--bg-toggle);
        border: 1px solid #c9c9c9;
        border-radius: 14px;
        display: flex;
        align-items: center;
        padding: 0 var(--pd-toggle-switch);
        transition: background-color 500ms, border-color 500ms;
    }

    .toggle__circle {
        width: var(--w-h-toggle-circle);
        height: var(--w-h-toggle-circle);
        background-color: var(--bg-circle);
        border-radius: 50%;
        transition: margin 400ms ease-in-out, background-color 1000ms;
    }

    #checkbox:checked + .toggle .toggle__circle {
        margin-left: calc(var(--w-toggle-switch) - (var(--pd-toggle-switch) * 2) - var(--w-h-toggle-circle));
    }

    #checkbox:checked + .toggle .toggle__switch {
        /* Cor azul #4f8cff em HSL */
        --bg-toggle: #0f4d80ff;
        --bg-circle: hsl(0, 0%, 96%);
        border-color: #0f4d80ff(220, 100%, 66%);
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(34, 34, 59, 0.5); /* Fundo um pouco mais escuro para foco */
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem; /* Espaçamento das bordas da tela */
        box-sizing: border-box;
    }

    .modal-content {
        background: #fff;
        border-radius: 10px;
        width: 100%;
        max-width: 560px; /* Largura máxima em telas grandes */
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
        
        /* Chave para a responsividade de altura e rolagem */
        max-height: 90dvh; /* Altura máxima de 90% da tela */
        display: flex;
        flex-direction: column;
    }

    .modal-content h2 {
        margin-top: 0;
        color: #22223b;
        font-size: 1.2rem;
        flex-shrink: 0; /* Impede que o título encolha */
    }

    .modal-content .clausulas-texto {
        overflow-y: auto; /* Habilita a rolagem APENAS para o texto */
        margin-bottom: 24px; /* Mais espaço antes do checkbox */
        padding-right: 10px; /* Espaço para a barra de rolagem não colar no texto */
    }

    .modal-content .modal-footer {
        flex-shrink: 0; /* Impede que o rodapé encolha */
        margin-top: auto; /* Empurra o rodapé para baixo se houver espaço */
    }
    </style>
</head>
<body>
     <!-- ESTE É O NOVO CÓDIGO -->
    <div id="success-message" style="display: none; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 16px; margin: 20px auto; max-width: 480px; border-radius: 8px; text-align: center;">
        <strong>Solicitação enviada com sucesso!</strong> Agradecemos o seu contato.
    </div>
    <!-- FIM DO NOVO CÓDIGO -->

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(submitted) {window.location.href = window.location.pathname + '?status=success'}"></iframe>    
    <form action="https://docs.google.com/forms/d/1pr90R0dg5tZwr1F4MBDPMLuHnJ-TJCNwu5M5E574ntQ/formResponse" method="POST" target="hidden_iframe" onsubmit="submitted=true;">
        <h1>Solicitação de Demonstrações</h1>
         <!-- INÍCIO DO NOVO CÓDIGO -->
        <div class="form-group">
            <input type="checkbox" name="entry.2109653665" id="checkbox" hidden="">
                <label for="checkbox" class="toggle">
              <span class="toggle__label toggle__label--cliente">Cliente</span>
              <div class="toggle__switch">
                <div class="toggle__circle"></div>
              </div>
                <span class="toggle__label toggle__label--representante">Representante</span>
            </label>
        </div>

        <div class="form-group">
            <label for="empresa">Empresa:</label>
            <input type="text" id="empresa" name="entry.939840906" required>
        </div>

        <div class="form-group">
            <label for="representante">Representante Brightlux:</label>
            <input type="text" id="representante" name="entry.1068215217" required>
        </div>

        <div class="form-group">
            <label for="documento">CNPJ/CPF do Representante Brightlux:</label>
            <input type="text" id="documento" name="entry.2112486120" required pattern="\d{3}\.?\d{3}\.?\d{3}-?\d{2}|\d{2}\.?\d{3}\.?\d{3}/?\d{4}-?\d{2}" title="Digite um CPF (000.000.000-00) ou CNPJ (00.000.000/0000-00)" maxlength="18" oninput="formatarDocumento(this)">
        </div>

        <div class="form-group cliente-fields">
            <label for="cliente_final">Cliente Final:</label>
            <input type="text" id="cliente_final" name="entry.223596000" required>
        </div>

        <div class="form-group cliente-fields">
            <label for="cliente_documento">CNPJ/CPF do Cliente:</label>
            <input type="text" id="cliente_documento" name="entry.1609051213" required pattern="\d{3}\.?\d{3}\.?\d{3}-?\d{2}|\d{2}\.?\d{3}\.?\d{3}/?\d{4}-?\d{2}" title="Digite um CPF (000.000.000-00) ou CNPJ (00.000.000/0000-00)" maxlength="18" oninput="formatarDocumento(this)">
        </div>

        <div class="form-group">
            <label for="cliente_cep">CEP:</label>
            <input type="text" id="cliente_cep" name="entry.326951211" required pattern="\d{5}-?\d{3}" maxlength="9" oninput="formatarCEP(this)">
        </div>
        <div class="form-group" style="flex-direction: row; gap: 12px; align-items: flex-end;">
            <div style="flex: 2; display: flex; flex-direction: column;">
                <label for="cliente_endereco">Endereço:</label>
                <input type="text" id="cliente_endereco" name="entry.528116576" required style="width: 90%;">
            </div>
            <div style="flex: 1; display: flex; flex-direction: column;">
                <label for="cliente_numero">Número:</label>
                <input type="text" id="cliente_numero" name="entry.720227532" required style="width: 88%;"> 
            </div>
        </div>

        <div class="form-group">
            <label for="cliente_bairro">Bairro:</label>
            <input type="text" id="cliente_bairro" name="entry.994537204" required>
        </div>
        <div class="form-group" style="flex-direction: row; gap: 12px; align-items: flex-end;">
             <div style="flex: 2; display: flex; flex-direction: column;">
                 <label for="cliente_cidade">Cidade:</label>
                 <input type="text" id="cliente_cidade" name="entry.1687851464" required style="width: 90%;">
             </div>
             <div style="flex: 1; display: flex; flex-direction: column;">
                 <label for="cliente_uf">UF:</label>
                 <input type="text" id="cliente_uf" name="entry.906954223" maxlength="2" required style="width: 88%;">
              </div>
        </div>

        <div class="form-group">
            <label for="cliente_email">E-mail:</label>
            <input type="email" id="cliente_email" name="entry.220162681" required pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" title="Digite um e-mail válido">
        </div>

        <div class="form-group">
            <div class="produto-label-row">
                <label>Produto(s) Emprestado(s):</label>
                <button type="button" id="add-produto" title="Adicionar produto">+</button>
            </div>
            <div id="produtos-container">
                <!-- A primeira linha de produto é corrigida aqui -->
                <div class="produto-row">
                    <select class="familia-select" required>
                        <option value="">Selecione a família</option>
                        <option value="LED HBMI">HIGHBAY HBMI</option>
                        <option value="IP69K">HERMÉTICA IP69K</option>
                        <option value="LEX100">LEX100</option>
                        <option value="INFINITY">LINEAR LED</option>
                        <option value="CRYF">PROJETOR CRYF</option>
                    </select>
                    <!-- Os campos de produto e quantidade começam escondidos -->
                    <select name="entry.1785792562" class="produto-select" required style="display: none;"></select>
                    <input type="number" name="entry.1633719381" class="quantidade-input" min="1" max="2" value="1" required style="width:30px; display: none;">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="valor_total">Valor Total dos Itens:</label>
            <input type="number" id="valor_total" name="entry.1388108285" min="0" step="0.01" required readonly style="background-color: #e9ecef; color: #495057;">
        </div>

        <div class="form-group">
            <label for="data_devolucao">Prazo de Devolução:</label>
            <input type="date" id="data_devolucao" name="entry.319298411" required>
        </div>
        
        <!-- O botão de envio principal foi movido para fora do modal -->
        <button type="submit">Revisar e Enviar</button>
        
        <!-- Modal -->
        <div id="modal-clausulas" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; overflow-y: auto; background:rgba(34,34,59,0.4); align-items:center; justify-content:center;">            
            <div style="background:#fff; border-radius:10px; max-width:560px; width:90%; margin: 20px 0; padding:32px 24px 20px 24px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative;">            
                <h2 style="margin-top:0; color:#22223b; font-size:1.2rem;">Declarações e Responsabilidades</h2>
                <div class="clausulas-texto">
                </div>
                <label style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                    <input type="checkbox" id="concordo-checkbox">
                    Li e concordo com os termos.
                </label>
                <div style="display:flex; justify-content:flex-end; gap:8px;">
                    <button type="button" id="fechar-modal" style="background:#bfc9d1; color:#22223b; border:none; border-radius:6px; padding:8px 20px; font-size:1rem; font-weight:500; cursor:pointer; min-width:90px;">Cancelar</button>
                    <!-- Este botão agora apenas confirma, o envio real é feito fora do modal -->
                    <button type="button" id="enviar-btn-modal" disabled style="background:#0f4d80ff; color:#fff; border:none; border-radius:6px; padding:8px 20px; font-size:1rem; font-weight:500; cursor:pointer; min-width:90px; opacity: 0.5;">Enviar</button>
                </div>
            </div>
        </div>
    </form>

   
    
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- LÓGICA INDEPENDENTE (RODA IMEDIATAMENTE) ---

    // --- Lógica do Toggle Cliente/Representante ---
    const toggleCheckbox = document.getElementById('checkbox');
    const clienteFields = document.querySelectorAll('.cliente-fields');
    const clienteFinalInput = document.getElementById('cliente_final');
    const clienteDocumentoInput = document.getElementById('cliente_documento');
    const clausulasContainer = document.querySelector('.clausulas-texto');

    // Armazena os dois textos das cláusulas para fácil troca
    const clausulasCliente = `
        <p><span class="clausula-num">I.</span> O Cliente Final solicita o envio dos produto(s) listado(s) acima em perfeitas condições mediante a NF de demonstração CFOP <strong>xxxx</strong>, os valores dos itens discriminados na NF serão de acordo com a <strong>Tabela de Preços de Demonstração</strong>. O cliente compromete-se a utilizar o(s) produto(s) de forma adequada e a devolvê-lo(s) no prazo máximo de <strong>60 dias</strong> a partir da emissão da NF.</p>
        <p><span class="clausula-num">II.</span> O Cliente Final assume a responsabilidade pela guarda e conservação do(s) produto(s) durante o período de demonstração, comprometendo-se a comunicar imediatamente qualquer dano ou perda ao Representante.</p>
        <p><span class="clausula-num">III.</span> O Cliente Final autoriza o Representante a retirar o(s) produto(s) no endereço indicado acima, no prazo combinado, ou a devolvê-lo(s) diretamente à empresa, conforme orientação do Representante.</p>
        <p><span class="clausula-num">IV.</span> Caso o Cliente Final decida adquirir o(s) produto(s) demonstrado(s), o valor pago será ajustado conforme o valor unitário informado em orçamento, e o produto será considerado parte integrante do pedido de venda.</p>
        <p><span class="clausula-num">V.</span> Em caso de deterioração, perda ou não devolução do(s) produto(s), o Cliente Final será responsável pelo pagamento do valor integral do(s) produto(s) constantes em NF, incluindo tributos aplicáveis.</p>
    `;

    const clausulasRepresentante = `
        <p><span class="clausula-num">I.</span> <strong>Representante</strong> se compromete a devolver o(s) produto(s) em perfeito estado, dentro do prazo máximo de <strong>60 dias</strong>, a contar da data de emissão da Nota fiscal.<br><span class="clausula-sub"><strong>a)</strong></span> Em caso de atraso na devolução, o <strong>Representante</strong> pagará uma multa de 0,33% do valor do produto por dia de atraso.</p>
        <p><span class="clausula-num">II.</span> Caso o produto seja instalado em um cliente final, o <strong>Representante</strong> deve:<br><span class="clausula-sub"><strong>a)</strong></span> Obter um <strong>Termo de Recebimento assinado pelo cliente</strong> em caso de demonstração para instalação no cliente.<br><span class="clausula-sub"><strong>b)</strong></span> Informar a empresa sobre a instalação, fornecendo os dados do cliente e o prazo estimado para retirada.<br><span class="clausula-sub"><strong>c)</strong></span> Assumir total responsabilidade pela recuperação do produto.</p>
        <p><span class="clausula-num">III.</span> Em caso de deterioração, perda ou não devolução do produto, o <strong>Representante</strong> será responsável pelo pagamento do valor integral do produto, incluindo ICMS e outros tributos (exceto em Amostras de Demonstração instaladas no cliente, este deverá ser ressarcido pelo próprio cliente).</p>
        <p><span class="clausula-num">IV.</span> A empresa reserva-se o direito de bloquear novas solicitações de peças de demonstração até a regularização de pendências.</p>
    `;

    function handleToggleChange() {
        const isRepresentante = toggleCheckbox.checked;

        if (isRepresentante) {
            // Modo Representante: Oculta campos do cliente
            clienteFields.forEach(field => field.style.display = 'none');
            // IMPORTANTE: Desativa a obrigatoriedade dos campos ocultos
            clienteFinalInput.required = false;
            clienteDocumentoInput.required = false;
            // Troca o texto das cláusulas
            clausulasContainer.innerHTML = clausulasRepresentante;
        } else {
            // Modo Cliente: Mostra campos do cliente
            clienteFields.forEach(field => field.style.display = 'flex');
            // IMPORTANTE: Reativa a obrigatoriedade
            clienteFinalInput.required = true;
            clienteDocumentoInput.required = true;
            // Restaura o texto original das cláusulas
            clausulasContainer.innerHTML = clausulasCliente;
        }
    }

    // Adiciona o listener e chama a função uma vez para definir o estado inicial
    if (toggleCheckbox) {
        toggleCheckbox.addEventListener('change', handleToggleChange);
        handleToggleChange(); // Define o estado inicial (Cliente)
    }

    // Exibe a mensagem de sucesso se o parâmetro 'status=success' estiver na URL
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    if (status === 'success') {
        const successMessage = document.getElementById('success-message');
        if (successMessage) { // Verifica se o elemento existe
            successMessage.style.display = 'block';
            window.scrollTo(0, 0);
            history.replaceState(null, '', window.location.pathname);
        }
    }

    // Funções globais de formatação (movidas para dentro do escopo para organização)
    function formatarCEP(input) {
        let v = input.value.replace(/\D/g, '');
        if (v.length > 5) v = v.replace(/^(\d{5})(\d)/, '$1-$2');
        input.value = v;
    }
    window.formatarCEP = formatarCEP; // Expõe ao HTML se chamado por oninput

    function formatarDocumento(input) {
        let v = input.value.replace(/\D/g, '');
        if (v.length <= 11) {
            v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
            v = v.replace(/^(\d{2})(\d)/, '$1.$2'); v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3'); v = v.replace(/\.(\d{3})(\d)/, '.$1/$2'); v = v.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
        }
        input.value = v;
    }
    window.formatarDocumento = formatarDocumento; // Expõe ao HTML se chamado por oninput

    // Configuração da data de devolução
    const dataInput = document.getElementById('data_devolucao');
    if (dataInput) {
        const today = new Date();
        const maxDate = new Date();
        maxDate.setDate(today.getDate() + 60);
        const formatDate = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        dataInput.min = formatDate(today);
        dataInput.max = formatDate(maxDate);
    }

    // Busca de CEP
    const cepInput = document.getElementById('cliente_cep');
    if (cepInput) {
        cepInput.addEventListener('blur', function() {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.erro) {
                            document.getElementById('cliente_endereco').value = data.logradouro || '';
                            document.getElementById('cliente_bairro').value = data.bairro || '';
                            document.getElementById('cliente_cidade').value = data.localidade || '';
                            document.getElementById('cliente_uf').value = data.uf || '';
                        }
                    }).catch(error => console.error('Erro ao buscar CEP:', error));
            }
        });
    }

    // Lógica do Modal de Cláusulas
    const form = document.querySelector('form');
    const modal = document.getElementById('modal-clausulas');
    if (form && modal) {
        const concordo = document.getElementById('concordo-checkbox');
        const enviarBtnModal = document.getElementById('enviar-btn-modal');
        const fecharModal = document.getElementById('fechar-modal');
        let formSubmissionAllowed = false;

        form.addEventListener('submit', function(e) {
            if (!formSubmissionAllowed) {
                e.preventDefault(); 
                if (form.checkValidity()) {
                    modal.style.display = 'flex';
                    concordo.checked = false;
                    enviarBtnModal.disabled = true;
                    enviarBtnModal.style.opacity = '0.5';
                } else {
                    form.reportValidity();
                }
            }
        });

        concordo.addEventListener('change', function() {
            enviarBtnModal.disabled = !this.checked;
            enviarBtnModal.style.opacity = this.checked ? '1' : '0.5';
        });

        fecharModal.addEventListener('click', () => { modal.style.display = 'none'; });
        enviarBtnModal.addEventListener('click', () => {
            if (concordo.checked) {
                formSubmissionAllowed = true;
                form.submit();
            }
        });
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    }

    // --- FIM DA LÓGICA INDEPENDENTE ---

    
    // --- FUNÇÃO QUE INICIA A LÓGICA DE PRODUTOS (dependente do fetch) ---
    function initializeProductLogic(produtosPorFamilia) {
        
        const produtosMap = [
            { produto: "entry.1785792562", quantidade: "entry.1633719381" },
            { produto: "entry.1181593751", quantidade: "entry.951350632" },
            { produto: "entry.129486384", quantidade: "entry.293899450" },
            { produto: "entry.817976781",  quantidade: "entry.706751794" },
        ];
        
        const produtosContainer = document.getElementById('produtos-container');
        const addBtn = document.getElementById('add-produto');
        const valorTotalInput = document.getElementById('valor_total');
        const maxProdutos = produtosMap.length;

        // --- INÍCIO DA ALTERAÇÃO ---

        // 1. FUNÇÃO PARA CALCULAR O VALOR TOTAL
        function calcularValorTotal() {
            let total = 0;
            const rows = document.querySelectorAll('.produto-row');

            rows.forEach(row => {
                const familiaSelect = row.querySelector('.familia-select');
                const produtoSelect = row.querySelector('.produto-select');
                const quantidadeInput = row.querySelector('.quantidade-input');

                const familiaKey = familiaSelect.value;
                const produtoDesc = produtoSelect.value;
                const quantidade = parseInt(quantidadeInput.value, 10) || 0;

                if (familiaKey && produtoDesc && quantidade > 0 && produtosPorFamilia[familiaKey]) {
                    // Encontra o objeto do produto para obter o preço
                    const produtoEncontrado = produtosPorFamilia[familiaKey].find(p => p.description === produtoDesc);
                    
                    if (produtoEncontrado) {
                        total += produtoEncontrado.price * quantidade;
                    }
                }
            });

            // Atualiza o campo de valor total com 2 casas decimais
            valorTotalInput.value = total.toFixed(2);
        }
        
        // 2. ATUALIZAR O EVENT LISTENER PARA CHAMAR A FUNÇÃO DE CÁLCULO
        produtosContainer.addEventListener('change', e => {
            if (e.target.classList.contains('familia-select')) {
                atualizarProdutos(e.target);
            }
            // Se o produto selecionado ou a quantidade mudar, recalcula o total
            if (e.target.classList.contains('produto-select') || e.target.classList.contains('quantidade-input')) {
                calcularValorTotal();
            }
        });

        // 3. ATUALIZAR A FUNÇÃO DE REMOVER PARA CHAMAR O CÁLCULO
        function addRemoveButton(row) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '−';
            removeBtn.className = 'remove-produto-btn';
            removeBtn.title = 'Remover produto';
            removeBtn.addEventListener('click', () => {
                row.remove();
                addBtn.disabled = false;
                calcularValorTotal(); // Recalcula ao remover
            });
            row.appendChild(removeBtn);
        }

        // 4. ATUALIZAR A FUNÇÃO DE ADICIONAR PARA CHAMAR O CÁLCULO
        addBtn.addEventListener('click', () => {
            const currentRowCount = produtosContainer.querySelectorAll('.produto-row').length;
            if (currentRowCount >= maxProdutos) return;
            
            const entryIds = produtosMap[currentRowCount];
            const newRow = document.createElement('div');
            newRow.className = 'produto-row';
            
            newRow.innerHTML = `
                <select class="familia-select" required><option value="">Selecione a família</option></select>
                <select name="${entryIds.produto}" class="produto-select" required style="display: none;"></select>
                <input type="number" name="${entryIds.quantidade}" class="quantidade-input" min="1" max="2" value="1" required style="width:30px; display: none;">
            `;
            
            popularFamilias(newRow.querySelector('.familia-select'));
            addRemoveButton(newRow);
            produtosContainer.appendChild(newRow);
            
            if (produtosContainer.querySelectorAll('.produto-row').length >= maxProdutos) addBtn.disabled = true;

            calcularValorTotal(); // Recalcula ao adicionar
        });

        // --- FIM DA ALTERAÇÃO ---

        // O resto do seu código original (popularFamilias, atualizarProdutos, etc.) continua aqui...
        const familiaDisplayNames = {
            "LED HBMI": "HIGHBAY HBMI",
            "IP69K": "HERMÉTICA IP69K",
            "LEX100": "LEX100",
            "INFINITY": "LINEAR LED",
            "CRYF": "PROJETOR CRYF"
        };

        function popularFamilias(selectElement) {
            // No seu código original, as famílias eram hardcoded.
            // A forma correta é usar as chaves do objeto que veio do JSON.
            const familias = Object.keys(produtosPorFamilia);
            familias.forEach(familiaKey => {
                const displayName = familiaDisplayNames[familiaKey] || familiaKey;
                const option = new Option(displayName, familiaKey);
                selectElement.appendChild(option);
            });
        }
        
        function atualizarProdutos(familiaSelect) {
            const row = familiaSelect.closest('.produto-row');
            const produtoSelect = row.querySelector('.produto-select');
            const quantidadeInput = row.querySelector('.quantidade-input');
            const selectedFamiliaKey = familiaSelect.value;

            produtoSelect.innerHTML = '<option value="">Selecione um produto</option>';
            produtoSelect.style.display = 'none';
            quantidadeInput.style.display = 'none';
            produtoSelect.required = false;

            if (selectedFamiliaKey && produtosPorFamilia[selectedFamiliaKey]) {
                const produtos = produtosPorFamilia[selectedFamiliaKey];
                if (produtos.length > 0) {
                    produtos.forEach(produto => {
                        const option = new Option(produto.description, produto.description);
                        produtoSelect.appendChild(option);
                    });
                    produtoSelect.style.display = 'block';
                    quantidadeInput.style.display = 'block';
                    produtoSelect.required = true;
                } else {
                    produtoSelect.innerHTML = '<option value="">Nenhum produto disponível</option>';
                    produtoSelect.style.display = 'block';
                }
            }
            calcularValorTotal(); // Recalcula quando a família muda
        }
        
        const primeiraFamiliaSelect = document.querySelector('.familia-select');
        primeiraFamiliaSelect.innerHTML = '<option value="">Selecione a família</option>'; 
        popularFamilias(primeiraFamiliaSelect);
        
        addRemoveButton(document.querySelector('.produto-row'));
        
        calcularValorTotal(); // Calcula o valor inicial (que será 0)

    } // Fim da função initializeProductLogic

    // --- PONTO DE ENTRADA DO FETCH (roda a lógica de produtos) ---
    fetch('./products.json')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log("Lista de produtos carregada!", data);
            initializeProductLogic(data);
        })
        .catch(error => {
            console.error("Erro ao carregar a lista de produtos:", error);
            const container = document.getElementById('produtos-container');
            if(container) {
                container.innerHTML = `<p style="color: red; padding: 10px; background: #ffebee; border-radius: 4px;">Erro ao carregar a lista de produtos. Por favor, recarregue a página.</p>`;
                const addBtn = document.getElementById('add-produto');
                if (addBtn) addBtn.style.display = 'none';
            }
        });
});
</script>